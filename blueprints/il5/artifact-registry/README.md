# Artifact Registry Blueprint
This blueprint demonstrates how to use Google Artifact Registry to manage Supply Chain Risk. It does this by proxying trusted RPM and Docker sources, allowing VMs to pull from VPC local caches.
The network should also be actively blocking non-GAR resources from being connected to in the environment.

## Introduction Google Artifact Registry
Google Artifact Registry (GAR) can be used as a proxy cache for external registries and repositories of various kinds, and can also be used to store build artifacts generated by CI/CD systems.

GAR Currently supports the following media types:
* Docker -	Store Docker container images and Helm charts packaged in OCI format. For more information on container image formats, see Container images.
* Maven -	Store Java packages that you build with Maven or Gradle. For more information on storing Java packages in Artifact Registry, see Manage Java packages.
* npm -	Store Node.js packages that you manage with npm. For more information on storing Node.js packages in Artifact Registry, see Manage Node.js packages
* Python -	Store Python packages. For more information on storing Python packages in Artifact Registry, see Manage Python packages
* Apt -	Store Debian packages that you manage with Apt. For more information on storing Debian packages in Artifact Registry, see Manage Debian packages.
* Yum -	Store RPM packages that you manage with Yum and DNF. For more information on storing RPM packages, see Manage RPM packages.
* Kubeflow -	Store Kubeflow pipeline templates. A pipeline template lets you reuse ML workflow definitions when you're managing ML workflows in Vertex AI.  Vertex AI is the Google Cloud ML platform for building, deploying, and managing ML models. To learn about creating pipeline templates and using them with Artifact Registry, see Create, upload, and use a pipeline template.
* Go -	Store Go modules. For more information on storing Go modules in Artifact Registry, see Work with Go modules.

For this blueprint, we demonstrate how to use a factory pattern to create proxy Yum repositories for CentOS-9-Stream and Docker proxy registries for Docker Hub, Quay.io, and registry.k8s.io.
The blueprint also creates a CentOS-9-Stream instance with a startup-script that disables non-GAR registries and writes a configuration to `/etc/yum.repos.d/` for using GAR.

## Disclaimer
- The present GCP Terraform Module in this project is set up and intended to be implemented in an IL5 Impact Level 5 environment using the Assured Workdloads within the Google Cloud Platform (GCP) organization.
- An Assured Workloads and IL5 environments ensures that sensitive data and workloads in GCP adhere to the rigorous security standards mandated by the DoD, making it suitable for government agencies.
<!-- BEGIN TFDOC -->
## Variables

| name | description | type | required | default |
|---|---|:---:|:---:|:---:|
| [keyring](variables.tf#L8) | Keyring attributes. | <code>string</code> | ✓ |  |
| [keys](variables.tf#L13) | Key names and base attributes. Set attributes to null if not needed. | <code title="map&#40;object&#40;&#123;&#10;  destroy_scheduled_duration    &#61; optional&#40;string&#41;&#10;  rotation_period               &#61; optional&#40;string&#41;&#10;  labels                        &#61; optional&#40;map&#40;string&#41;&#41;&#10;  location                      &#61; optional&#40;string, &#34;us-east4&#34;&#41;&#10;  purpose                       &#61; optional&#40;string, &#34;ENCRYPT_DECRYPT&#34;&#41;&#10;  skip_initial_version_creation &#61; optional&#40;bool, false&#41;&#10;  version_template &#61; optional&#40;object&#40;&#123;&#10;    algorithm        &#61; string&#10;    protection_level &#61; optional&#40;string, &#34;HSM&#34;&#41;&#10;  &#125;&#41;&#41;&#10;&#10;&#10;  iam &#61; optional&#40;map&#40;list&#40;string&#41;&#41;, &#123;&#125;&#41;&#10;  iam_bindings &#61; optional&#40;map&#40;object&#40;&#123;&#10;    members &#61; list&#40;string&#41;&#10;    role    &#61; string&#10;    condition &#61; optional&#40;object&#40;&#123;&#10;      expression  &#61; string&#10;      title       &#61; string&#10;      description &#61; optional&#40;string&#41;&#10;    &#125;&#41;&#41;&#10;  &#125;&#41;&#41;, &#123;&#125;&#41;&#10;&#10;&#10;  iam_bindings_additive &#61; optional&#40;map&#40;object&#40;&#123;&#10;    member &#61; string&#10;    role   &#61; string&#10;    condition &#61; optional&#40;object&#40;&#123;&#10;      expression  &#61; string&#10;      title       &#61; string&#10;      description &#61; optional&#40;string&#41;&#10;    &#125;&#41;&#41;&#10;  &#125;&#41;&#41;, &#123;&#125;&#41;&#10;&#125;&#41;&#41;&#10;&#10;&#10;default &#61; &#123;&#10;  &#34;artifact-registry&#34; &#61; &#123;&#10;    destroy_scheduled_duration    &#61; null&#10;    rotation_period               &#61; null&#10;    labels                        &#61; null&#10;    purpose                       &#61; &#34;ENCRYPT_DECRYPT&#34;&#10;    skip_initial_version_creation &#61; false&#10;    version_template &#61; &#123;&#10;      algorithm        &#61; &#34;GOOGLE_SYMMETRIC_ENCRYPTION&#34;&#10;      protection_level &#61; &#34;HSM&#34;&#10;    &#125;&#10;&#10;&#10;    iam                   &#61; &#123;&#125;&#10;    iam_bindings          &#61; &#123;&#125;&#10;    iam_bindings_additive &#61; &#123;&#125;&#10;  &#125;&#10;&#125;&#10;&#10;&#10;nullable &#61; false">&#8230;</code> | ✓ |  |
| [project](variables.tf#L72) | GCP Project to deploy Google Artifact Registries into. | <code>string</code> | ✓ |  |
| [region](variables.tf#L78) | GCP Region to deploy Google Artifact Registries into. | <code>string</code> | ✓ |  |
| [compute_vpc](variables.tf#L1) | VPC for deploying the compute VM which will access the registry. | <code>string</code> |  | <code>&#34;&#34;</code> |

## Outputs

| name | description | sensitive |
|---|---|:---:|
| [docker_registries](outputs.tf#L1) | Docker registries created from teh docker-registries.yaml file, with Docker Hub appended. |  |
| [yum_repositories](outputs.tf#L6) | Yum repositories created from the yum-repos.yaml file. |  |
<!-- END TFDOC -->
### Yum Reposistories
This blueprint deploys 2 Yum registries for pull-through proxying

Structure:
```yaml
yum:
  centos9-stream-baseos:
    remote:
      base: CENTOS_STREAM
      path: 9-stream/BaseOS/x86_64/os
```
This will create a GAR that proxies the URL [https://<base>/<path>](https://mirror.stream.centos.org/9-stream/BaseOS/x86_64/os)

To add more Yum repositories, simply add new objects below `yum:`

### Docker Registries
This blueprint deploys 3 Docker Registries for pull-through proxying access

Structure
```yaml
docker:
  registry-k8s-io:
      remote:
        uri: https://registry.k8s.io
```

This will proxy the registry.k8s.io registry
To add more Docker registries, simply add new objects below `docker:`

## Verification of a successful deployment?
To verify the correct deployment of this blueprint:
1. In [Google Artifact Registry](https://console.cloud.google.com/artifacts) you should see 5 registries created
1. Inspect "centos9-stream-appstream", it shouldn't have any RPMs cached yet
1. Use the oslogin SSH to connect to the "rpm-consumer" VM
1. Run `sudo dnf update -y` from inside the "rpm-consumer" VM, wait for it to complete
1. Revisit the "centos9-stream-appstream" page in Google Artifact Registry and refresh the page, you should now see RPMs cached.



